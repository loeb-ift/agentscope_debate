# 🤖 AI 辯論系統邏輯總覽 (System Logic Overview v2.6)

本文檔整理了目前 AI 辯論平台的完整運作邏輯，涵蓋了從啟動、分析、執行到結算的各個環節，以及其背後的韌性機制。

---

## 1. 🚀 啟動階段 (Initialization)

1.  **配置 (Config)**：用戶透過前端設定辯題、輪次、主席與參賽團隊。
2.  **任務分發**：API 將任務發送至 Redis 隊列 (Celery)。
3.  **即時連線**：前端透過 Server-Sent Events (SSE) 訂閱 `debate:{id}:log_stream`，實時接收戰況。

---

## 2. 🧠 賽前分析 (Pre-debate Analysis)

*   **執行者**：主席 (Chairman)
*   **核心邏輯 (Prompt v2.6)**：
    *   **時間維度**：動態計算當前季度 (`{{CURRENT_QUARTER}}`)，判斷政策窗口與數據可得性。
    *   **區域感知**：識別議題所屬區域 (台灣/美國/全球)，鎖定正確的貨幣單位與監管機構。
    *   **產業識別**：自動識別涉及產業 (L1-L5)，並生成龍頭企業清單 (e.g., 台積電) 作為數據驗證標竿。
*   **產出**：主席手卡 (Handcard) 與 戰略摘要，指導後續辯論方向。

---

## 3. 🛠️ 工具選擇 (Tool Selection)

*   **執行者**：所有辯手 (Debaters)
*   **流程**：
    1.  系統提供可用工具列表 (Tool Registry)。
    2.  Agent 根據辯題與自身角色，挑選 3-5 個最關鍵的工具。
    3.  **容錯解析**：支援解析 List (`[...]`) 或 Object (`{"tools": [...]}`) 格式，防止模型格式錯誤導致無工具可用。

---

## 4. ⚔️ 辯論循環 (Debate Loop)

系統依序執行 N 輪辯論，每輪包含以下階段：

### 4.1 團隊內部討論 (Intra-Team Deliberation)

每個團隊成員依序發言，核心是 **「多步執行迴圈 (Multi-Step Execution Loop)」**：

1.  **思考與決策**：Agent 決定是直接發言，還是調用工具。
2.  **工具執行 (Max Steps: 5)**：
    *   **自動糾錯**：若 Agent 輸入錯誤工具名 (如 `TEJ`)，系統自動進行模糊匹配，回傳建議 (`Did you mean: tej.stock_price?`)。
    *   **結果反饋**：工具執行結果即時反饋給 Agent，供其修正或進行下一步。
3.  **資源協商 (Resource Negotiation)**：
    *   若 5 次機會用盡，Agent 可選擇「總結」或「申請延長調查」。
    *   **海馬迴攔截 (Hippocampal Interception)**：系統優先查詢共享記憶庫。
        *   **命中**：若發現相關資料，**自動駁回**延長申請，並直接提供資料給 Agent。
        *   **未命中**：轉交主席進行人工審核。
    *   **主席介入**：若申請延長且海馬迴無資料，主席根據理由審核。
        *   ✅ **批准**：增加 3 次機會 (`EXTENSION_STEPS`)。
        *   ❌ **拒絕**：強制進入總結。
4.  **強制收斂 (Forced Convergence)**：
    *   若最終仍超時，系統自動生成 **「證據摘要報告」**，列出已查到的數據，確保該回合有實質產出。

### 4.2 中立核實 (Neutral Verification)

*   若為中立團隊 (Neutral)，將執行特殊的 **「事實查核」** 任務。
*   檢查前幾方提出的數據，調用工具進行驗證，並給予評分懲罰。

### 4.3 團隊總結

*   LLM 根據成員發言記錄，歸納出該團隊本輪的「共同觀點」與「內部分歧」。

### 4.4 主席回合總結

*   主席根據手卡與本輪戰況，進行點評。
*   **動態引導**：明確指出 **「第 N+1 輪」** 應該聚焦的關鍵問題。

---

## 5. 🏁 最終結算 (Finalization)

1.  **最終判決**：主席發表整場辯論的勝負判定與價值昇華。
2.  **評審團報告**：Jury Agent 生成詳細評分表。
3.  **報告歸檔**：
    *   生成 Markdown 報告，包含完整對話記錄。
    *   **時間統計**：記錄辯論開始、結束時間與總耗時。
4.  **結束信號**：發送 `[DONE]` 信號，通知前端斷開連接。

---

## 🔁 系統韌性設計 (System Resilience)

*   **Redis 穩定性**：統一使用 `RedisClient` 連線池，防止連線洩漏或超時掛起。
*   **異常恢復**：Agent 崩潰或工具失敗時，有自動重試與 Fallback 機制，確保流程不中斷。
*   **前端體驗**：按鈕操作具備 Loading 狀態與數據預加載，避免操作無反饋。