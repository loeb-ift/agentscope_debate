# EDA 場景驗證指南

## 場景說明

此驗證腳本模擬主席對「台積電 (2330.TW) 投資價值分析」進行完整的 EDA 自動分析流程。

## 驗證流程

```
步驟 1: 主席分析辯論主題
   ↓
步驟 2: 拉取股票歷史數據 (Yahoo Finance)
   ↓
步驟 3: 調用 ODS EDA 服務
   ↓
步驟 4: 品質檢查 (Gate Check)
   ↓
步驟 5: 攝取到 Evidence 系統
   ↓
步驟 6: 主席總結引用 EDA 數據
```

## 前置條件

1. **API 服務運行中**
   ```bash
   # 確認 docker-compose 正在運行
   docker-compose ps
   ```

2. **資料庫遷移已執行**
   ```bash
   python scripts/migrate_evidence_docs_eda.py
   ```

3. **必要套件已安裝**
   ```bash
   pip install yfinance pandas requests
   ```

## 執行驗證

```bash
cd /Users/loeb/Desktop/agentscope_debate
python verify_eda_scenario.py
```

## 預期輸出

### 成功情境

```
🎬🎬🎬🎬🎬🎬🎬🎬🎬🎬🎬🎬🎬🎬🎬🎬🎬🎬🎬🎬🎬🎬🎬🎬🎬🎬🎬🎬🎬🎬🎬🎬🎬🎬🎬
場景驗證：主席 EDA 自動分析完整流程
🎬🎬🎬🎬🎬🎬🎬🎬🎬🎬🎬🎬🎬🎬🎬🎬🎬🎬🎬🎬🎬🎬🎬🎬🎬🎬🎬🎬🎬🎬🎬🎬🎬🎬🎬

======================================================================
  步驟 1: 主席分析辯論主題
======================================================================
📋 辯論主題: 台積電 (2330.TW) 2024 年投資價值分析
🔍 識別股票代碼: 2330.TW
📅 數據回溯期: 120 天

======================================================================
  步驟 2: 拉取股票歷史數據
======================================================================
📥 從 Yahoo Finance 下載 2330.TW 數據...
✓ 數據已儲存: /data/staging/scenario_test_2330/2330.TW.csv

📊 數據摘要:
  - 資料筆數: 120
  - 日期範圍: 2024-08-18 ~ 2024-12-18
  - 收盤價範圍: $850.00 ~ $1050.00
  - 平均成交量: 25,000,000

======================================================================
  步驟 3: 調用 ODS EDA 服務
======================================================================
🔧 調用 API: POST http://localhost:8000/api/eda/describe
📦 請求參數:
  - CSV 路徑: /data/staging/scenario_test_2330/2330.TW.csv
  - 分析欄位: ['date', 'close', 'volume', 'high', 'low']
  - 抽樣數: 50000

✅ EDA 分析完成!
  - HTML 報表: /data/reports/scenario_test_2330/eda_profile.html
  - 圖表數量: 3
  - 摘要表格: 1

📈 數據品質指標:
  - 分析列數: 120
  - 分析欄位數: 5
  - 缺失率: 0.00%
  - 生成時間: 2024-12-18T06:27:00Z

======================================================================
  步驟 4: 品質檢查 (Gate Check)
======================================================================
🚪 執行品質檢查...

檢查結果: ✅ 通過

詳細檢查:
  ✓ files_exist
  ✓ sample_threshold
      樣本數: 120 (最低要求: 30)
  ✓ numeric_columns
      圖表數量: 3
  ✓ freshness
      報表年齡: 0.0 小時 (最大允許: 24 小時)

======================================================================
  步驟 5: 攝取到 Evidence 系統
======================================================================
💾 開始攝取 EDA artifacts...

  📄 攝取 HTML 報表...
     ✓ Evidence ID: abc-123-def

  📊 攝取圖表 (3 個)...
     ✓ [1] hist_distributions.png - Evidence ID: abc-124-def
     ✓ [2] corr_matrix.png - Evidence ID: abc-125-def
     ✓ [3] box_plots.png - Evidence ID: abc-126-def

  📋 攝取摘要表格 (1 個)...
     ✓ [1] summary_stats.csv - Evidence ID: abc-127-def

✅ 共攝取 5 個 Evidence 文件
📚 當前 debate 的 VERIFIED Evidence 總數: 5

======================================================================
  步驟 6: 主席總結引用 EDA 數據
======================================================================

## 主席總結 (基於 EDA 實證分析)

### 數據概覽
本輪針對 2330.TW 進行了自動化探索性數據分析，分析期間涵蓋 120 個交易日。
數據品質良好，缺失率僅 0.00%。

### 價格走勢分析
根據 EDA 報表 [E1]，2330.TW 在分析期間：
- 平均收盤價：$950.25
- 價格標準差：$45.30
- 期間漲跌幅：+12.50%

如直方圖所示 [E2]，收盤價呈現右偏分布，
顯示股價在此期間整體上漲。

### 成交量分析
平均日成交量為 25,000,000 股。根據相關矩陣 [E3]，
成交量與價格波動之間的相關性需進一步檢視。

### 投資建議
基於上述量化分析，建議投資人：
1. 關注價格波動風險（標準差 $45.30）
2. 參考成交量變化判斷市場情緒
3. 結合基本面分析做出投資決策

---
**Evidence 引用:**
- [E1] EDA 自動報表 (ID: abc-123-def)
- [E2] 價格分布直方圖 (ID: abc-124-def)
- [E3] 相關矩陣 (ID: abc-125-def)

======================================================================
  ✅ 場景驗證完成
======================================================================

📊 執行摘要:
  - 辯論主題: 台積電 (2330.TW) 2024 年投資價值分析
  - 股票代碼: 2330.TW
  - 數據筆數: 120
  - EDA 報表: /data/reports/scenario_test_2330/eda_profile.html
  - 生成圖表: 3 個
  - Gate 檢查: ✅ 通過
  - Evidence 文件: 5 個

🎯 驗證結果:
  ✓ 數據拉取成功
  ✓ EDA 分析完成
  ✓ 品質檢查執行
  ✓ Evidence 系統整合
  ✓ 主席總結生成
```

## 驗證重點

### 1. 數據拉取
- ✅ 從 Yahoo Finance 成功下載台積電數據
- ✅ CSV 正確儲存到 `/data/staging/{debate_id}/` 目錄
- ✅ 數據格式符合預期 (date, open, high, low, close, volume)

### 2. EDA API
- ✅ API 端點正常回應
- ✅ 生成 HTML 報表
- ✅ 生成 3 個圖表 (直方圖、相關矩陣、箱型圖)
- ✅ 生成摘要統計 CSV
- ✅ Metadata 正確

### 3. Gate 檢查
- ✅ 檔案存在性檢查
- ✅ 樣本數門檻檢查
- ✅ 數值欄位檢查
- ✅ 新鮮度檢查

### 4. Evidence 系統
- ✅ 成功攝取 5 個 Evidence 文件
- ✅ 所有文件狀態為 VERIFIED
- ✅ Trust score 設定為 90
- ✅ TTL 設定為 24 小時

### 5. 主席總結
- ✅ 正確引用 Evidence ID
- ✅ 包含量化數據 (均值、標準差、漲跌幅)
- ✅ 提供投資建議
- ✅ 格式化輸出

## 故障排除

### 問題 1: API 連線失敗
```
錯誤: requests.exceptions.ConnectionError
```
**解決方案**: 確認 docker-compose 服務正在運行
```bash
docker-compose ps
docker-compose up -d  # 如果未運行
```

### 問題 2: 資料庫欄位不存在
```
錯誤: column "artifact_type" does not exist
```
**解決方案**: 執行資料庫遷移
```bash
python scripts/migrate_evidence_docs_eda.py
```

### 問題 3: Yahoo Finance 下載失敗
```
錯誤: yfinance download failed
```
**解決方案**: 
- 檢查網路連線
- 確認股票代碼正確
- 嘗試使用其他股票代碼 (如 AAPL, TSLA)

### 問題 4: Gate 檢查失敗
```
警告: Gate check failed
```
**預期行為**: 這是正常的降級機制，系統會使用定性描述而非量化分析

## 清理

驗證完成後，可選擇清理測試數據：

```bash
rm -rf /data/staging/scenario_test_2330
rm -rf /data/reports/scenario_test_2330
rm -rf /data/plots/scenario_test_2330
rm -rf /data/tables/scenario_test_2330
```

## 下一步

場景驗證成功後，可以繼續：
1. 實作 Layer 4 (Chairman 整合)
2. 端到端辯論測試
3. 前端 UI 整合
