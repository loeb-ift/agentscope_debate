# å·¥å…·é›†ï¼ˆToolSetï¼‰æ¶æ§‹è¨­è¨ˆ

## è¨­è¨ˆç†å¿µ

### âŒ èˆŠæ¶æ§‹çš„å•é¡Œ
```python
# Prompt ç¡¬ç·¨ç¢¼å·¥å…·åˆ—è¡¨
user_prompt = f"""
è«‹ä½¿ç”¨ä»¥ä¸‹å·¥å…·ï¼š
1. tej.stock_price - æŸ¥è©¢è‚¡åƒ¹
2. searxng.search - ç¶²é æœå°‹
"""
```

**å•é¡Œ**ï¼š
- Agent è¢«å¼·åˆ¶ä½¿ç”¨ç‰¹å®šå·¥å…·
- å¤±å»è‡ªä¸»é¸æ“‡èƒ½åŠ›
- ç„¡æ³•éˆæ´»ç®¡ç†å·¥å…·æ¬Šé™
- é›£ä»¥æ“´å±•å’Œç¶­è­·

### âœ… æ–°æ¶æ§‹ï¼šå·¥å…·é›†ç³»çµ±

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   ToolSet   â”‚  å·¥å…·é›† = å·¥å…·çš„é›†åˆ
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”œâ”€ Tool 1: tej.stock_price
       â”œâ”€ Tool 2: tej.company_info
       â””â”€ Tool 3: searxng.search

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    Agent    â”‚  Agent è¢«åˆ†é…å·¥å…·é›†
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”œâ”€ ToolSet A (assigned)
       â”œâ”€ ToolSet B (assigned)
       â””â”€ Global ToolSet (è‡ªå‹•)
```

**å„ªå‹¢**ï¼š
- âœ… Agent è‡ªä¸»æ±ºå®šä½¿ç”¨å“ªäº›å·¥å…·
- âœ… éˆæ´»çš„æ¬Šé™ç®¡ç†
- âœ… å¯é‡ç”¨çš„å·¥å…·é›†
- âœ… å‰ç«¯å¯è¦–åŒ–ç®¡ç†

---

## è³‡æ–™åº«è¨­è¨ˆ

### 1. ToolSet è¡¨
```sql
CREATE TABLE toolsets (
    id TEXT PRIMARY KEY,              -- UUID
    name TEXT NOT NULL,               -- å·¥å…·é›†åç¨±
    description TEXT,                 -- æè¿°
    tool_names JSON NOT NULL,         -- ["tej.stock_price", "searxng.search"]
    is_global BOOLEAN DEFAULT FALSE,  -- æ˜¯å¦ç‚ºå…¨å±€å·¥å…·é›†
    created_at TIMESTAMP,
    updated_at TIMESTAMP
);
```

### 2. AgentToolSet é—œè¯è¡¨ï¼ˆå¤šå°å¤šï¼‰
```sql
CREATE TABLE agent_toolsets (
    id TEXT PRIMARY KEY,
    agent_id TEXT NOT NULL,    -- FK to agents.id
    toolset_id TEXT NOT NULL,  -- FK to toolsets.id
    created_at TIMESTAMP
);
```

---

## å·¥å…·é›†é¡å‹

### 1. å…¨å±€å·¥å…·é›†ï¼ˆGlobal ToolSetï¼‰
- **è‡ªå‹•åˆ†é…**çµ¦æ‰€æœ‰ Agent
- åŒ…å«æ‰€æœ‰å·²è¨»å†Šçš„å·¥å…·
- ç³»çµ±è‡ªå‹•ç¶­è­·

```python
{
    "name": "å…¨å±€å·¥å…·é›†",
    "description": "åŒ…å«æ‰€æœ‰å·²è¨»å†Šçš„å·¥å…·",
    "tool_names": [
        "tej.stock_price",
        "tej.company_info",
        "searxng.search",
        "yfinance.stock_info",
        ...  # æ‰€æœ‰ 25 å€‹ TEJ å·¥å…·
    ],
    "is_global": True
}
```

### 2. å°ˆç”¨å·¥å…·é›† (Specialized ToolSet)
- **æ‰‹å‹•åˆ†é…**çµ¦ç‰¹å®š Agent
- é‡å°ç‰¹å®šä»»å‹™è¨­è¨ˆï¼Œä¸¦éµå¾ª **L1-L4 å„ªå…ˆç´šé«”ç³»**ã€‚

#### å·¥å…·å„ªå…ˆç´šé«”ç³» (Priority Hierarchy)

| ç´šåˆ¥ | ä¿¡ä»»ç­‰ç´š | ä»£è¡¨å·¥å…· | æ²»ç†é‚è¼¯ |
| :--- | :--- | :--- | :--- |
| **L1: æ ¸å¿ƒå…§éƒ¨** | ğŸŒŸğŸŒŸğŸŒŸğŸŒŸğŸŒŸ | `chinatimes.*` | æ ¸å¿ƒå ±åƒ¹èˆ‡è²¡å ±ï¼Œå…å‡†æ ¸ä¸”å„ªå…ˆèª¿ç”¨ã€‚ |
| **L2: å®˜æ–¹åˆ†æ** | ğŸŒŸğŸŒŸğŸŒŸğŸŒŸ | `financial.pdr_reader`, `twse.*` | å…¨çƒæ•¸æ“šèˆ‡å°ˆæ¥­é©—è­‰ã€‚ |
| **L3: å—é™æ¢ç´¢** | ğŸŒŸğŸŒŸ | `browser.*`, `search.*` | é«˜æˆæœ¬å·¥å…·ï¼Œéœ€ä¸»å¸­å‡†æ ¸ã€‚ |
| **L4: æ¸¬è©¦å‚™æ´** | ğŸŒŸ | `tej.*` | åƒ…ä½œæœ€å¾Œå‚™æ´ã€‚ |

---

## ç¾æœ‰å°ˆç”¨å·¥å…·é›†å¯¦ä½œ (Real-world Implementation)

ä»¥ä¸‹ç‚ºç›®å‰ç³»çµ±ä¸­å¯¦éš›éƒ¨ç½²çš„å°ˆç”¨å·¥å…·é›†ç¯„ä¾‹ï¼š

**ç¯„ä¾‹ 1ï¼šæˆ°ç•¥å·¥å…·é›† (Strategic ToolSet)**
- **ç”¨é€”**: ä¾›ä¸»å¸­èˆ‡å®è§€åˆ†æå¸«é€²è¡Œæ·±åº¦æ±ºç­–ã€‚
- **å·¥å…·æ¸…å–®**:
    - [L1] `chinatimes.market_index`, `chinatimes.balance_sheet`, `chinatimes.stock_news`
    - [L2] `chairman.eda_analysis`, `ods.eda_describe`, `financial.pdr_reader`
    - [L3] `search.smart`, `browser.browse`
    - [L4] `tej.company_info`

**ç¯„ä¾‹ 2ï¼šé‡åŒ–åˆ†æå·¥å…·é›† (Quantitative ToolSet)**
- **ç”¨é€”**: å´é‡æŠ€è¡“æŒ‡æ¨™èˆ‡é«˜é »å ±åƒ¹é©—è­‰ã€‚
- **å·¥å…·æ¸…å–®**:
    - [L1] `chinatimes.stock_rt`, `chinatimes.stock_kline`
    - [L2] `financial.technical_analysis`, `financial.get_verified_price`
    - [L4] `tej.stock_price`

---

## API è¨­è¨ˆ

### ToolSet ç®¡ç†

#### 1. å‰µå»ºå·¥å…·é›†
```http
POST /api/v1/toolsets
Content-Type: application/json

{
    "name": "å°è‚¡åˆ†æå·¥å…·é›†",
    "description": "å°ˆé–€ç”¨æ–¼å°ç£è‚¡å¸‚åˆ†æ",
    "tool_names": [
        "tej.stock_price",
        "tej.company_info"
    ],
    "is_global": false
}
```

#### 2. åˆ—å‡ºæ‰€æœ‰å·¥å…·é›†
```http
GET /api/v1/toolsets
GET /api/v1/toolsets?is_global=true
```

#### 3. ç²å–å·¥å…·é›†è©³æƒ…ï¼ˆåŒ…å«å·¥å…·åˆ—è¡¨ï¼‰
```http
GET /api/v1/toolsets/{toolset_id}

Response:
{
    "toolset": {
        "id": "uuid",
        "name": "å°è‚¡åˆ†æå·¥å…·é›†",
        ...
    },
    "tools": [
        {
            "name": "tej.stock_price",
            "version": "v1",
            "description": "æŸ¥è©¢å°è‚¡è‚¡åƒ¹æ•¸æ“š",
            "schema": {...}
        },
        ...
    ]
}
```

### Agent-ToolSet é—œè¯

#### 1. åˆ†é…å·¥å…·é›†çµ¦ Agent
```http
POST /api/v1/agents/{agent_id}/toolsets
Content-Type: application/json

{
    "toolset_id": "uuid"
}
```

#### 2. ç²å– Agent çš„æ‰€æœ‰å·¥å…·é›†
```http
GET /api/v1/agents/{agent_id}/toolsets

Response:
{
    "agent_id": "uuid",
    "agent_name": "è²¡å‹™åˆ†æå°ˆå®¶",
    "toolsets": [
        {
            "id": "uuid",
            "name": "å°è‚¡åˆ†æå·¥å…·é›†",
            "source": "assigned"
        },
        {
            "id": "uuid",
            "name": "å…¨å±€å·¥å…·é›†",
            "source": "global"
        }
    ]
}
```

#### 3. ç²å– Agent å¯ç”¨çš„æ‰€æœ‰å·¥å…·
```http
GET /api/v1/agents/{agent_id}/available-tools

Response:
[
    {
        "name": "tej.stock_price",
        "version": "v1",
        "description": "...",
        "schema": {...},
        "source": "assigned",
        "toolset_name": "å°è‚¡åˆ†æå·¥å…·é›†"
    },
    {
        "name": "searxng.search",
        "version": "v1",
        "description": "...",
        "schema": {...},
        "source": "global",
        "toolset_name": "å…¨å±€å·¥å…·é›†"
    }
]
```

---

## Prompt ç”Ÿæˆé‚è¼¯

### èˆŠæ–¹å¼ï¼ˆç¡¬ç·¨ç¢¼ï¼‰
```python
user_prompt = f"""
è«‹ä½¿ç”¨ä»¥ä¸‹å·¥å…·ï¼š
1. tej.stock_price - æŸ¥è©¢è‚¡åƒ¹
2. searxng.search - ç¶²é æœå°‹
"""
```

### æ–°æ–¹å¼ï¼ˆå‹•æ…‹ç”Ÿæˆï¼‰
```python
from api.toolset_service import ToolSetService

# 1. ç²å– Agent å¯ç”¨çš„å·¥å…·
available_tools = ToolSetService.get_agent_available_tools(db, agent_id)

# 2. æ ¼å¼åŒ–ç‚º Prompt
tools_prompt = ToolSetService.format_tools_for_prompt(available_tools)

# 3. æ³¨å…¥åˆ° Prompt
user_prompt = f"""
{tools_prompt}

è«‹æ ¹æ“šéœ€è¦é¸æ“‡åˆé©çš„å·¥å…·ä¾†å®Œæˆä»»å‹™ã€‚
"""
```

**ç”Ÿæˆçš„ Prompt ç¯„ä¾‹**ï¼š
```
**å¯ç”¨å·¥å…·**ï¼š
1. tej.stock_price (v1) - æŸ¥è©¢å°è‚¡è‚¡åƒ¹æ•¸æ“š
   åƒæ•¸: coid, start_date, end_date, limit
   ä¾†æº: å°è‚¡åˆ†æå·¥å…·é›† (assigned)

2. tej.company_info (v1) - æŸ¥è©¢å…¬å¸åŸºæœ¬è³‡æ–™
   åƒæ•¸: coid
   ä¾†æº: å°è‚¡åˆ†æå·¥å…·é›† (assigned)

3. searxng.search (v1) - ç¶²é æœå°‹
   åƒæ•¸: q, engines
   ä¾†æº: å…¨å±€å·¥å…·é›† (global)

è«‹æ ¹æ“šéœ€è¦é¸æ“‡åˆé©çš„å·¥å…·ä¾†å®Œæˆä»»å‹™ã€‚
```

---

## å‰ç«¯è¨­è¨ˆ

### 1. å·¥å…·é›†ç®¡ç†é é¢

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å·¥å…·é›†ç®¡ç†                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                         â”‚
â”‚  â”Œâ”€ å‰µå»ºæ–°å·¥å…·é›† â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ åç¨±: [___________________]      â”‚   â”‚
â”‚  â”‚ æè¿°: [___________________]      â”‚   â”‚
â”‚  â”‚                                  â”‚   â”‚
â”‚  â”‚ é¸æ“‡å·¥å…·:                        â”‚   â”‚
â”‚  â”‚ â˜‘ tej.stock_price               â”‚   â”‚
â”‚  â”‚ â˜‘ tej.company_info              â”‚   â”‚
â”‚  â”‚ â˜ searxng.search                â”‚   â”‚
â”‚  â”‚ â˜ yfinance.stock_info           â”‚   â”‚
â”‚  â”‚                                  â”‚   â”‚
â”‚  â”‚ â˜ è¨­ç‚ºå…¨å±€å·¥å…·é›†                 â”‚   â”‚
â”‚  â”‚                                  â”‚   â”‚
â”‚  â”‚ [å‰µå»ºå·¥å…·é›†]                     â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                         â”‚
â”‚  â”Œâ”€ ç¾æœ‰å·¥å…·é›† â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                                  â”‚  â”‚
â”‚  â”‚ ğŸ“¦ å°è‚¡åˆ†æå·¥å…·é›† (6 å€‹å·¥å…·)     â”‚  â”‚
â”‚  â”‚    [ç·¨è¼¯] [åˆªé™¤] [æŸ¥çœ‹è©³æƒ…]      â”‚  â”‚
â”‚  â”‚                                  â”‚  â”‚
â”‚  â”‚ ğŸŒ å…¨å±€å·¥å…·é›† (28 å€‹å·¥å…·)        â”‚  â”‚
â”‚  â”‚    [æŸ¥çœ‹è©³æƒ…]                    â”‚  â”‚
â”‚  â”‚                                  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2. Agent ç®¡ç†é é¢ï¼ˆå·¥å…·é›†åˆ†é…ï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Agent: è²¡å‹™åˆ†æå°ˆå®¶                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                         â”‚
â”‚  åŸºæœ¬è³‡è¨Š:                              â”‚
â”‚  è§’è‰²: analyst                          â”‚
â”‚  å°ˆé•·: å°è‚¡è²¡å‹™åˆ†æ                      â”‚
â”‚                                         â”‚
â”‚  â”Œâ”€ åˆ†é…çš„å·¥å…·é›† â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                                  â”‚   â”‚
â”‚  â”‚ âœ“ å°è‚¡åˆ†æå·¥å…·é›†                 â”‚   â”‚
â”‚  â”‚   6 å€‹å·¥å…· | [ç§»é™¤]              â”‚   â”‚
â”‚  â”‚                                  â”‚   â”‚
â”‚  â”‚ âœ“ å…¨å±€å·¥å…·é›† (è‡ªå‹•)              â”‚   â”‚
â”‚  â”‚   28 å€‹å·¥å…·                      â”‚   â”‚
â”‚  â”‚                                  â”‚   â”‚
â”‚  â”‚ [+ æ·»åŠ å·¥å…·é›†]                   â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                         â”‚
â”‚  â”Œâ”€ å¯ç”¨å·¥å…·é è¦½ (34 å€‹) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ tej.stock_price                  â”‚   â”‚
â”‚  â”‚ tej.company_info                 â”‚   â”‚
â”‚  â”‚ searxng.search                   â”‚   â”‚
â”‚  â”‚ ...                              â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## å¯¦ç¾æ­¥é©Ÿ

### âœ… å·²å®Œæˆ
1. è³‡æ–™åº« Modelï¼ˆToolSet, AgentToolSetï¼‰
2. Pydantic Schemas
3. ToolSetServiceï¼ˆæ¥­å‹™é‚è¼¯ï¼‰
4. ToolRegistry æ“´å±•ï¼ˆget_tool_info, list_toolsï¼‰

### ğŸ”„ é€²è¡Œä¸­
5. ToolSet API ç«¯é»
6. Agent-ToolSet é—œè¯ API

### â³ å¾…å®Œæˆ
7. æ›´æ–° debate_cycle.py ä½¿ç”¨å‹•æ…‹å·¥å…·åˆ—è¡¨
8. Gradio å‰ç«¯ï¼šå·¥å…·é›†ç®¡ç†é é¢
9. Gradio å‰ç«¯ï¼šAgent å·¥å…·é›†åˆ†é…
10. å‰µå»ºé è¨­å·¥å…·é›†ï¼ˆå…¨å±€ã€å°è‚¡åˆ†æç­‰ï¼‰

---

## ä½¿ç”¨ç¯„ä¾‹

### å ´æ™¯ 1ï¼šå‰µå»ºå°ˆé–€çš„è²¡å‹™åˆ†æ Agent

```python
# 1. å‰µå»ºå°è‚¡åˆ†æå·¥å…·é›†
toolset = {
    "name": "å°è‚¡åˆ†æå·¥å…·é›†",
    "tool_names": [
        "tej.stock_price",
        "tej.company_info",
        "tej.monthly_revenue",
        "tej.financial_summary"
    ]
}

# 2. å‰µå»º Agent
agent = {
    "name": "è²¡å‹™åˆ†æå°ˆå®¶",
    "role": "analyst",
    "specialty": "å°è‚¡è²¡å‹™åˆ†æ"
}

# 3. åˆ†é…å·¥å…·é›†çµ¦ Agent
assign_toolset(agent_id, toolset_id)

# 4. Agent è‡ªå‹•ç²å¾—å·¥å…·åˆ—è¡¨
# - å°è‚¡åˆ†æå·¥å…·é›†ï¼ˆ4 å€‹å·¥å…·ï¼‰
# - å…¨å±€å·¥å…·é›†ï¼ˆ28 å€‹å·¥å…·ï¼‰
# ç¸½å…± 32 å€‹å¯ç”¨å·¥å…·
```

### å ´æ™¯ 2ï¼šé™åˆ¶ Agent åªèƒ½ä½¿ç”¨ç‰¹å®šå·¥å…·

```python
# 1. å‰µå»ºå—é™å·¥å…·é›†
restricted_toolset = {
    "name": "åƒ…æœå°‹å·¥å…·é›†",
    "tool_names": ["searxng.search"]
}

# 2. åˆ†é…çµ¦ Agent
# 3. å¦‚æœéœ€è¦ï¼Œå¯ä»¥ç¦ç”¨å…¨å±€å·¥å…·é›†ï¼ˆæœªä¾†åŠŸèƒ½ï¼‰
```

---

## å„ªå‹¢ç¸½çµ

1. **éˆæ´»æ€§** - Agent å¯ä»¥è‡ªä¸»é¸æ“‡å·¥å…·
2. **å¯é‡ç”¨æ€§** - å·¥å…·é›†å¯ä»¥åˆ†é…çµ¦å¤šå€‹ Agent
3. **å¯ç¶­è­·æ€§** - é›†ä¸­ç®¡ç†å·¥å…·æ¬Šé™
4. **å¯æ“´å±•æ€§** - è¼•é¬†æ·»åŠ æ–°å·¥å…·å’Œå·¥å…·é›†
5. **å¯è¦–åŒ–** - å‰ç«¯æ¸…æ™°å±•ç¤ºå·¥å…·é—œä¿‚
6. **å®‰å…¨æ€§** - ç²¾ç´°æ§åˆ¶ Agent çš„å·¥å…·è¨ªå•æ¬Šé™

---

## ä¸‹ä¸€æ­¥

1. **ç«‹å³å¯¦ç¾**ï¼šToolSet API ç«¯é»ï¼ˆ30 åˆ†é˜ï¼‰
2. **çŸ­æœŸ**ï¼šæ›´æ–° debate_cycle.pyï¼ˆ30 åˆ†é˜ï¼‰
3. **ä¸­æœŸ**ï¼šGradio å‰ç«¯ï¼ˆ2-3 å°æ™‚ï¼‰
