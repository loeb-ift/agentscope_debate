# å·¥å…·é›†ï¼ˆToolSetï¼‰æ¶æ§‹è¨­è¨ˆ

## è¨­è¨ˆç†å¿µ

### âŒ èˆŠæ¶æ§‹çš„å•é¡Œ
```python
# Prompt ç¡¬ç·¨ç¢¼å·¥å…·åˆ—è¡¨
user_prompt = f"""
è«‹ä½¿ç”¨ä»¥ä¸‹å·¥å…·ï¼š
1. tej.stock_price - æŸ¥è©¢è‚¡åƒ¹
2. searxng.search - ç¶²é æœå°‹
"""
```

**å•é¡Œ**ï¼š
- Agent è¢«å¼·åˆ¶ä½¿ç”¨ç‰¹å®šå·¥å…·
- å¤±å»è‡ªä¸»é¸æ“‡èƒ½åŠ›
- ç„¡æ³•éˆæ´»ç®¡ç†å·¥å…·æ¬Šé™
- é›£ä»¥æ“´å±•å’Œç¶­è­·

### âœ… æ–°æ¶æ§‹ï¼šå·¥å…·é›†ç³»çµ±

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   ToolSet   â”‚  å·¥å…·é›† = å·¥å…·çš„é›†åˆ
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”œâ”€ Tool 1: tej.stock_price
       â”œâ”€ Tool 2: tej.company_info
       â””â”€ Tool 3: searxng.search

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    Agent    â”‚  Agent è¢«åˆ†é…å·¥å…·é›†
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”œâ”€ ToolSet A (assigned)
       â”œâ”€ ToolSet B (assigned)
       â””â”€ Global ToolSet (è‡ªå‹•)
```

**å„ªå‹¢**ï¼š
- âœ… Agent è‡ªä¸»æ±ºå®šä½¿ç”¨å“ªäº›å·¥å…·
- âœ… éˆæ´»çš„æ¬Šé™ç®¡ç†
- âœ… å¯é‡ç”¨çš„å·¥å…·é›†
- âœ… å‰ç«¯å¯è¦–åŒ–ç®¡ç†

---

## è³‡æ–™åº«è¨­è¨ˆ

### 1. ToolSet è¡¨
```sql
CREATE TABLE toolsets (
    id TEXT PRIMARY KEY,              -- UUID
    name TEXT NOT NULL,               -- å·¥å…·é›†åç¨±
    description TEXT,                 -- æè¿°
    tool_names JSON NOT NULL,         -- ["tej.stock_price", "searxng.search"]
    is_global BOOLEAN DEFAULT FALSE,  -- æ˜¯å¦ç‚ºå…¨å±€å·¥å…·é›†
    created_at TIMESTAMP,
    updated_at TIMESTAMP
);
```

### 2. AgentToolSet é—œè¯è¡¨ï¼ˆå¤šå°å¤šï¼‰
```sql
CREATE TABLE agent_toolsets (
    id TEXT PRIMARY KEY,
    agent_id TEXT NOT NULL,    -- FK to agents.id
    toolset_id TEXT NOT NULL,  -- FK to toolsets.id
    created_at TIMESTAMP
);
```

---

## å·¥å…·é›†é¡å‹

### 1. å…¨å±€å·¥å…·é›†ï¼ˆGlobal ToolSetï¼‰
- **è‡ªå‹•åˆ†é…**çµ¦æ‰€æœ‰ Agent
- åŒ…å«æ‰€æœ‰å·²è¨»å†Šçš„å·¥å…·
- ç³»çµ±è‡ªå‹•ç¶­è­·

```python
{
    "name": "å…¨å±€å·¥å…·é›†",
    "description": "åŒ…å«æ‰€æœ‰å·²è¨»å†Šçš„å·¥å…·",
    "tool_names": [
        "tej.stock_price",
        "tej.company_info",
        "searxng.search",
        "yfinance.stock_info",
        ...  # æ‰€æœ‰ 25 å€‹ TEJ å·¥å…·
    ],
    "is_global": True
}
```

### 2. å°ˆç”¨å·¥å…·é›† (Specialized ToolSet)
- **æ‰‹å‹•åˆ†é…**çµ¦ç‰¹å®š Agent
- é‡å°ç‰¹å®šä»»å‹™è¨­è¨ˆï¼Œä¸¦éµå¾ª **L1-L4 å„ªå…ˆç´šé«”ç³»**ï¼ˆä¸‹è¡¨ç‚ºè¨­è¨ˆç¤ºæ„ï¼Œè€Œéç¡¬æ€§è¦å®šï¼‰ã€‚

#### å·¥å…·å„ªå…ˆç´šé«”ç³» (Priority Hierarchy)

| ç´šåˆ¥ | ä¿¡ä»»ç­‰ç´š | ä»£è¡¨å·¥å…·ï¼ˆç¤ºæ„ï¼‰ | æ²»ç†é‚è¼¯ |
| :--- | :--- | :--- | :--- |
| **L1: æ ¸å¿ƒå…§éƒ¨** | ğŸŒŸğŸŒŸğŸŒŸğŸŒŸğŸŒŸ | `tej.*`, `internal.*` | é«˜ä¿¡ä»»å…§éƒ¨æˆ–æˆæ¬Šé‡‘èè³‡æ–™ï¼Œå„ªå…ˆèª¿ç”¨ã€‚ |
| **L2: å®˜æ–¹åˆ†æ** | ğŸŒŸğŸŒŸğŸŒŸğŸŒŸ | `yfinance.stock_price`, `twse.*` | å®˜æ–¹/æ¬Šå¨ä¾†æºæ•¸æ“šèˆ‡å°ˆæ¥­é©—è­‰ã€‚ |
| **L3: å—é™æ¢ç´¢** | ğŸŒŸğŸŒŸ | `searxng.search`, `duckduckgo.search`, `web.fetch` | é«˜æˆæœ¬æˆ–é¢¨éšªè¼ƒé«˜çš„é–‹æ”¾ç¶²è·¯æ¢ç´¢ï¼Œéœ€è¼ƒåš´æ ¼æ²»ç†ã€‚ |
| **L4: æ¸¬è©¦å‚™æ´** | ğŸŒŸ | å…¶ä»–è©¦é©—æ€§å·¥å…· | åƒ…ä½œå‚™æ´æˆ–å¯¦é©—ç”¨é€”ã€‚ |

> è¨»ï¼šæ—©æœŸè¨­è¨ˆä¸­æ›¾ä»¥ `chinatimes.*`, `financial.*`, `browser.*` ç­‰å‘½åä½œç‚ºç¤ºä¾‹ï¼Œé€™äº›åç¨±æœªå¿…åœ¨ç•¶å‰ç‰ˆæœ¬ä¸­å…¨éƒ¨å¯¦ä½œã€‚å¯¦éš›å¯ç”¨å·¥å…·è«‹ä»¥ `/tools` API å›å‚³çµæœèˆ‡ `worker/celery_app.py` ä¸­çš„è¨»å†Šå…§å®¹ç‚ºæº–ã€‚

---

## å°ˆç”¨å·¥å…·é›†è¨­è¨ˆç¤ºä¾‹ (Design Examples)

ä»¥ä¸‹ç‚ºå°ˆç”¨å·¥å…·é›†çš„è¨­è¨ˆç¯„ä¾‹ï¼Œç›®çš„åœ¨æ–¼èªªæ˜å¦‚ä½•çµåˆã€Œå·¥å…·å„ªå…ˆç´šã€èˆ‡ã€Œä»»å‹™å ´æ™¯ã€ã€‚å¯¦éš›ç³»çµ±ä¸­å•Ÿç”¨çš„å·¥å…·åç¨±èˆ‡çµ„åˆï¼Œä»¥ç•¶å‰ç¨‹å¼ç¢¼èˆ‡ç’°å¢ƒé…ç½®ç‚ºæº–ï¼š

**ç¯„ä¾‹ 1ï¼šæˆ°ç•¥å·¥å…·é›† (Strategic ToolSet)**
- **ç”¨é€”**: ä¾›ä¸»å¸­èˆ‡å®è§€åˆ†æå¸«é€²è¡Œæ·±åº¦æ±ºç­–ã€‚
- **å·¥å…·æ¸…å–®**:
    - [L1] `chinatimes.market_index`, `chinatimes.balance_sheet`, `chinatimes.stock_news`
    - [L2] `chairman.eda_analysis`, `ods.eda_describe`, `financial.pdr_reader`
    - [L3] `search.smart`, `browser.browse`
    - [L4] `tej.company_info`

**ç¯„ä¾‹ 2ï¼šé‡åŒ–åˆ†æå·¥å…·é›† (Quantitative ToolSet)**
- **ç”¨é€”**: å´é‡æŠ€è¡“æŒ‡æ¨™èˆ‡é«˜é »å ±åƒ¹é©—è­‰ã€‚
- **å·¥å…·æ¸…å–®**:
    - [L1] `chinatimes.stock_rt`, `chinatimes.stock_kline`
    - [L2] `financial.technical_analysis`, `financial.get_verified_price`
    - [L4] `tej.stock_price`

---

## API è¨­è¨ˆ

### ToolSet ç®¡ç†

#### 1. å‰µå»ºå·¥å…·é›†
```http
POST /api/v1/toolsets
Content-Type: application/json

{
    "name": "å°è‚¡åˆ†æå·¥å…·é›†",
    "description": "å°ˆé–€ç”¨æ–¼å°ç£è‚¡å¸‚åˆ†æ",
    "tool_names": [
        "tej.stock_price",
        "tej.company_info"
    ],
    "is_global": false
}
```

#### 2. åˆ—å‡ºæ‰€æœ‰å·¥å…·é›†
```http
GET /api/v1/toolsets
GET /api/v1/toolsets?is_global=true
```

#### 3. ç²å–å·¥å…·é›†è©³æƒ…ï¼ˆåŒ…å«å·¥å…·åˆ—è¡¨ï¼‰
```http
GET /api/v1/toolsets/{toolset_id}

Response:
{
    "toolset": {
        "id": "uuid",
        "name": "å°è‚¡åˆ†æå·¥å…·é›†",
        ...
    },
    "tools": [
        {
            "name": "tej.stock_price",
            "version": "v1",
            "description": "æŸ¥è©¢å°è‚¡è‚¡åƒ¹æ•¸æ“š",
            "schema": {...}
        },
        ...
    ]
}
```

### Agent-ToolSet é—œè¯

#### 1. åˆ†é…å·¥å…·é›†çµ¦ Agent
```http
POST /api/v1/agents/{agent_id}/toolsets
Content-Type: application/json

{
    "toolset_id": "uuid"
}
```

#### 2. ç²å– Agent çš„æ‰€æœ‰å·¥å…·é›†
```http
GET /api/v1/agents/{agent_id}/toolsets

Response:
{
    "agent_id": "uuid",
    "agent_name": "è²¡å‹™åˆ†æå°ˆå®¶",
    "toolsets": [
        {
            "id": "uuid",
            "name": "å°è‚¡åˆ†æå·¥å…·é›†",
            "source": "assigned"
        },
        {
            "id": "uuid",
            "name": "å…¨å±€å·¥å…·é›†",
            "source": "global"
        }
    ]
}
```

#### 3. ç²å– Agent å¯ç”¨çš„æ‰€æœ‰å·¥å…·
```http
GET /api/v1/agents/{agent_id}/available-tools

Response:
[
    {
        "name": "tej.stock_price",
        "version": "v1",
        "description": "...",
        "schema": {...},
        "source": "assigned",
        "toolset_name": "å°è‚¡åˆ†æå·¥å…·é›†"
    },
    {
        "name": "searxng.search",
        "version": "v1",
        "description": "...",
        "schema": {...},
        "source": "global",
        "toolset_name": "å…¨å±€å·¥å…·é›†"
    }
]
```

---

## Prompt ç”Ÿæˆé‚è¼¯

### èˆŠæ–¹å¼ï¼ˆç¡¬ç·¨ç¢¼ï¼‰
```python
user_prompt = f"""
è«‹ä½¿ç”¨ä»¥ä¸‹å·¥å…·ï¼š
1. tej.stock_price - æŸ¥è©¢è‚¡åƒ¹
2. searxng.search - ç¶²é æœå°‹
"""
```

### æ–°æ–¹å¼ï¼ˆå‹•æ…‹ç”Ÿæˆï¼‰
```python
from api.toolset_service import ToolSetService

# 1. ç²å– Agent å¯ç”¨çš„å·¥å…·
available_tools = ToolSetService.get_agent_available_tools(db, agent_id)

# 2. æ ¼å¼åŒ–ç‚º Prompt
tools_prompt = ToolSetService.format_tools_for_prompt(available_tools)

# 3. æ³¨å…¥åˆ° Prompt
user_prompt = f"""
{tools_prompt}

è«‹æ ¹æ“šéœ€è¦é¸æ“‡åˆé©çš„å·¥å…·ä¾†å®Œæˆä»»å‹™ã€‚
"""
```

**ç”Ÿæˆçš„ Prompt ç¯„ä¾‹**ï¼š
```
**å¯ç”¨å·¥å…·**ï¼š
1. tej.stock_price (v1) - æŸ¥è©¢å°è‚¡è‚¡åƒ¹æ•¸æ“š
   åƒæ•¸: coid, start_date, end_date, limit
   ä¾†æº: å°è‚¡åˆ†æå·¥å…·é›† (assigned)

2. tej.company_info (v1) - æŸ¥è©¢å…¬å¸åŸºæœ¬è³‡æ–™
   åƒæ•¸: coid
   ä¾†æº: å°è‚¡åˆ†æå·¥å…·é›† (assigned)

3. searxng.search (v1) - ç¶²é æœå°‹
   åƒæ•¸: q, engines
   ä¾†æº: å…¨å±€å·¥å…·é›† (global)

è«‹æ ¹æ“šéœ€è¦é¸æ“‡åˆé©çš„å·¥å…·ä¾†å®Œæˆä»»å‹™ã€‚
```

---

## å‰ç«¯è¨­è¨ˆ

### 1. å·¥å…·é›†ç®¡ç†é é¢

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å·¥å…·é›†ç®¡ç†                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                         â”‚
â”‚  â”Œâ”€ å‰µå»ºæ–°å·¥å…·é›† â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ åç¨±: [___________________]      â”‚   â”‚
â”‚  â”‚ æè¿°: [___________________]      â”‚   â”‚
â”‚  â”‚                                  â”‚   â”‚
â”‚  â”‚ é¸æ“‡å·¥å…·:                        â”‚   â”‚
â”‚  â”‚ â˜‘ tej.stock_price               â”‚   â”‚
â”‚  â”‚ â˜‘ tej.company_info              â”‚   â”‚
â”‚  â”‚ â˜ searxng.search                â”‚   â”‚
â”‚  â”‚ â˜ yfinance.stock_info           â”‚   â”‚
â”‚  â”‚                                  â”‚   â”‚
â”‚  â”‚ â˜ è¨­ç‚ºå…¨å±€å·¥å…·é›†                 â”‚   â”‚
â”‚  â”‚                                  â”‚   â”‚
â”‚  â”‚ [å‰µå»ºå·¥å…·é›†]                     â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                         â”‚
â”‚  â”Œâ”€ ç¾æœ‰å·¥å…·é›† â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                                  â”‚  â”‚
â”‚  â”‚ ğŸ“¦ å°è‚¡åˆ†æå·¥å…·é›† (6 å€‹å·¥å…·)     â”‚  â”‚
â”‚  â”‚    [ç·¨è¼¯] [åˆªé™¤] [æŸ¥çœ‹è©³æƒ…]      â”‚  â”‚
â”‚  â”‚                                  â”‚  â”‚
â”‚  â”‚ ğŸŒ å…¨å±€å·¥å…·é›† (28 å€‹å·¥å…·)        â”‚  â”‚
â”‚  â”‚    [æŸ¥çœ‹è©³æƒ…]                    â”‚  â”‚
â”‚  â”‚                                  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2. Agent ç®¡ç†é é¢ï¼ˆå·¥å…·é›†åˆ†é…ï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Agent: è²¡å‹™åˆ†æå°ˆå®¶                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                         â”‚
â”‚  åŸºæœ¬è³‡è¨Š:                              â”‚
â”‚  è§’è‰²: analyst                          â”‚
â”‚  å°ˆé•·: å°è‚¡è²¡å‹™åˆ†æ                      â”‚
â”‚                                         â”‚
â”‚  â”Œâ”€ åˆ†é…çš„å·¥å…·é›† â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                                  â”‚   â”‚
â”‚  â”‚ âœ“ å°è‚¡åˆ†æå·¥å…·é›†                 â”‚   â”‚
â”‚  â”‚   6 å€‹å·¥å…· | [ç§»é™¤]              â”‚   â”‚
â”‚  â”‚                                  â”‚   â”‚
â”‚  â”‚ âœ“ å…¨å±€å·¥å…·é›† (è‡ªå‹•)              â”‚   â”‚
â”‚  â”‚   28 å€‹å·¥å…·                      â”‚   â”‚
â”‚  â”‚                                  â”‚   â”‚
â”‚  â”‚ [+ æ·»åŠ å·¥å…·é›†]                   â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                         â”‚
â”‚  â”Œâ”€ å¯ç”¨å·¥å…·é è¦½ (34 å€‹) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ tej.stock_price                  â”‚   â”‚
â”‚  â”‚ tej.company_info                 â”‚   â”‚
â”‚  â”‚ searxng.search                   â”‚   â”‚
â”‚  â”‚ ...                              â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## å¯¦ç¾æ­¥é©Ÿ

### âœ… å·²å®Œæˆ
1. è³‡æ–™åº« Modelï¼ˆToolSet, AgentToolSetï¼‰
2. Pydantic Schemas
3. ToolSetServiceï¼ˆæ¥­å‹™é‚è¼¯ï¼‰
4. ToolRegistry æ“´å±•ï¼ˆget_tool_info, list_toolsï¼‰

### ğŸ”„ é€²è¡Œä¸­
5. ToolSet API ç«¯é»
6. Agent-ToolSet é—œè¯ API

### â³ å¾…å®Œæˆ
7. æ›´æ–° debate_cycle.py ä½¿ç”¨å‹•æ…‹å·¥å…·åˆ—è¡¨
8. Gradio å‰ç«¯ï¼šå·¥å…·é›†ç®¡ç†é é¢
9. Gradio å‰ç«¯ï¼šAgent å·¥å…·é›†åˆ†é…
10. å‰µå»ºé è¨­å·¥å…·é›†ï¼ˆå…¨å±€ã€å°è‚¡åˆ†æç­‰ï¼‰

---

## ä½¿ç”¨ç¯„ä¾‹

### å ´æ™¯ 1ï¼šå‰µå»ºå°ˆé–€çš„è²¡å‹™åˆ†æ Agent

```python
# 1. å‰µå»ºå°è‚¡åˆ†æå·¥å…·é›†
toolset = {
    "name": "å°è‚¡åˆ†æå·¥å…·é›†",
    "tool_names": [
        "tej.stock_price",
        "tej.company_info",
        "tej.monthly_revenue",
        "tej.financial_summary"
    ]
}

# 2. å‰µå»º Agent
agent = {
    "name": "è²¡å‹™åˆ†æå°ˆå®¶",
    "role": "analyst",
    "specialty": "å°è‚¡è²¡å‹™åˆ†æ"
}

# 3. åˆ†é…å·¥å…·é›†çµ¦ Agent
assign_toolset(agent_id, toolset_id)

# 4. Agent è‡ªå‹•ç²å¾—å·¥å…·åˆ—è¡¨
# - å°è‚¡åˆ†æå·¥å…·é›†ï¼ˆ4 å€‹å·¥å…·ï¼‰
# - å…¨å±€å·¥å…·é›†ï¼ˆ28 å€‹å·¥å…·ï¼‰
# ç¸½å…± 32 å€‹å¯ç”¨å·¥å…·
```

### å ´æ™¯ 2ï¼šé™åˆ¶ Agent åªèƒ½ä½¿ç”¨ç‰¹å®šå·¥å…·

```python
# 1. å‰µå»ºå—é™å·¥å…·é›†
restricted_toolset = {
    "name": "åƒ…æœå°‹å·¥å…·é›†",
    "tool_names": ["searxng.search"]
}

# 2. åˆ†é…çµ¦ Agent
# 3. å¦‚æœéœ€è¦ï¼Œå¯ä»¥ç¦ç”¨å…¨å±€å·¥å…·é›†ï¼ˆæœªä¾†åŠŸèƒ½ï¼‰
```

---

## å„ªå‹¢ç¸½çµ

1. **éˆæ´»æ€§** - Agent å¯ä»¥è‡ªä¸»é¸æ“‡å·¥å…·
2. **å¯é‡ç”¨æ€§** - å·¥å…·é›†å¯ä»¥åˆ†é…çµ¦å¤šå€‹ Agent
3. **å¯ç¶­è­·æ€§** - é›†ä¸­ç®¡ç†å·¥å…·æ¬Šé™
4. **å¯æ“´å±•æ€§** - è¼•é¬†æ·»åŠ æ–°å·¥å…·å’Œå·¥å…·é›†
5. **å¯è¦–åŒ–** - å‰ç«¯æ¸…æ™°å±•ç¤ºå·¥å…·é—œä¿‚
6. **å®‰å…¨æ€§** - ç²¾ç´°æ§åˆ¶ Agent çš„å·¥å…·è¨ªå•æ¬Šé™

---

## TEJ å·¥å…·éŒ¯èª¤è™•ç†èˆ‡ Fallback ç­–ç•¥

æœ¬ç« ç¯€èªªæ˜ã€Œå·¥å…·é›†æ¶æ§‹ã€åœ¨å¯¦éš›åŸ·è¡Œæ™‚ï¼Œå¦‚ä½•èˆ‡ TEJ å·¥å…·çš„éŒ¯èª¤è™•ç†ã€å‚™æ´éˆèˆ‡è¨˜æ†¶ç³»çµ±æ²»ç†æ•´åˆï¼Œå°æ‡‰åˆ°å¯¦ä½œç¨‹å¼ç¢¼ï¼š
- è³‡æ–™åº«æ—¥æœŸæ¢æ¸¬ï¼š`worker/debate_cycle.py:830` `_check_db_date_async`
- ä¸»å¸­è³½å‰åˆ†æï¼š`worker/chairman.py:82` `_investigate_topic_async` èˆ‡ `pre_debate_analysis`
- è¨˜æ†¶ç³»çµ±ï¼š`worker/memory.py` ä¸­ HippocampalMemory èˆ‡ ReMe ç³»åˆ—

### 1. Phase 18ï¼šè³‡æ–™åº«æ—¥æœŸæ¢æ¸¬ `_check_db_date_async`

åœ¨è¾¯è«–å•Ÿå‹•å‰ï¼Œç³»çµ±æœƒä»¥å°ç©é›» `2330.TW` ä½œç‚º canaryï¼Œé€é `_check_db_date_async` æ¢æ¸¬è³‡æ–™åº«çš„æœ€æ–°å¯ç”¨æ—¥æœŸã€‚å·¥å…·èª¿ç”¨èˆ‡ fallback éˆå¦‚ä¸‹ï¼š

- Primary Probe
  - è‹¥ `Config.ENABLE_TEJ_TOOLS == True`ï¼š
    - ä½¿ç”¨ `tej.stock_price` ä½œç‚ºä¸»è¦æ¢æ¸¬å·¥å…·ã€‚
  - è‹¥ `Config.ENABLE_TEJ_TOOLS == False`ï¼š
    - ç›´æ¥æ”¹ç”¨ `financial.get_verified_price` ä½œç‚ºä¸»è¦æ¢æ¸¬å·¥å…·ã€‚
- Fallback éˆï¼ˆæ‰€æœ‰æ­¥é©Ÿçš†æœ‰ timeout èˆ‡éŒ¯èª¤æ•æ‰ï¼‰ï¼š
  1. `financial.get_verified_price`
  2. `twse.stock_day`ï¼ˆä»¥ `symbol="2330"`ã€ç•¶æ—¥æ—¥æœŸç‚ºåƒæ•¸ï¼‰
  3. `yahoo.stock_info`ï¼ˆæœ€å¾Œå‚™æ´ï¼‰

æ¢æ¸¬çµæœçš„ metadata æœƒå¯«å…¥ `DebateCycle.latest_db_date_meta`ï¼Œæ¬„ä½è¨­è¨ˆï¼š

- `source`ï¼šå¯¦éš›æ¡ç”¨è³‡æ–™ä¾†æºå·¥å…·åç¨±  
  - å¯èƒ½å€¼ï¼š`"tej.stock_price"`, `"financial.get_verified_price"`, `"twse.stock_day"`, `"yahoo.stock_info"`  
  - åŠŸèƒ½ä¸Šå°æ‡‰è¨­è¨ˆæ–‡ä»¶ä¸­æ‰€ç¨±çš„ `fallback_source`ã€‚
- `from_fallback`ï¼šå¸ƒæ—å€¼ï¼Œè¡¨ç¤ºæ˜¯å¦æœ‰å•Ÿç”¨å‚™æ´éˆ  
  - `False` ä»£è¡¨ç›´æ¥ä½¿ç”¨ primary tool  
  - `True` ä»£è¡¨ primary å¤±æ•—ã€æ”¹ç”¨å‚™æ´å·¥å…·ã€‚
- `error_chain`ï¼šå­—ä¸²ï¼Œä¸²æ¥ primary åŠå„å±¤ fallback çš„éŒ¯èª¤åŸå›   
  - åŠŸèƒ½ä¸Šå°æ‡‰è¨­è¨ˆæ–‡ä»¶ä¸­æ‰€ç¨±çš„ `fallback_reason`ã€‚
- `tool_meta`ï¼ˆé¸æ“‡æ€§ï¼‰ï¼šè‹¥åº•å±¤å·¥å…·å›å‚³ `_meta` æ¬„ä½ï¼Œæœƒè¢«åµŒå…¥åœ¨æ­¤ï¼Œæ–¹ä¾¿å‰ç«¯æˆ–æ—¥å¾Œæ’éŒ¯ã€‚

ç•¶æ‰€æœ‰æ¢æ¸¬å·¥å…·æœ€çµ‚éƒ½å¤±æ•—æ™‚ï¼š

- `latest_db_date` æœƒç¶­æŒç‚º `None`
- `latest_db_date_meta` ä»æœƒå¡«å…¥ä¸Šè¿°æ¬„ä½ï¼ˆè‡³å°‘åŒ…å« `source` èˆ‡ `error_chain`ï¼‰ï¼Œæ–¹ä¾¿è¿½è¹¤å¤±æ•—è·¯å¾‘ã€‚

### 2. ä¸»å¸­è³½å‰åˆ†æä¸­çš„ TEJ Fallback ç­–ç•¥

ä¸»å¸­è³½å‰åˆ†ææµç¨‹ä¸­ï¼ŒTEJ å·¥å…·ä¸»è¦å‡ºç¾åœ¨å…©å€‹éšæ®µï¼š

1. `Chairman._investigate_topic_async`ï¼ˆèƒŒæ™¯èª¿æŸ¥ï¼‰
2. `Chairman.pre_debate_analysis` å…§çš„å·¥å…·è£œæ•‘è¿´åœˆï¼ˆç•¶ LLM å›å‚³å·¥å…·å‘¼å« JSON æ™‚ï¼‰

å…·é«”ç­–ç•¥å¦‚ä¸‹ï¼š

- èƒŒæ™¯èª¿æŸ¥éšæ®µ (`_investigate_topic_async`)ï¼š
  - è‹¥ `Config.ENABLE_TEJ_TOOLS == True`ï¼Œä¸»å¸­æœƒå°‡ `tej.company_info`ã€`tej.stock_price` èˆ‡ `searxng.search` ä¸€èµ·è¨»å†Šæˆå¯ç”¨å·¥å…·ã€‚
  - LLM è‹¥ç”¢ç”Ÿ `tej.*` å·¥å…·å‘¼å«ï¼Œç³»çµ±èª¿ç”¨å¤±æ•—æˆ–å›å‚³ç©ºï¼éŒ¯èª¤è³‡æ–™æ™‚ï¼š
    - è‹¥å·¥å…·åç¨±å±¬æ–¼åƒ¹æ ¼é¡ï¼ˆä¾‹å¦‚ `tej.stock_price`ï¼‰ï¼Œæœƒæ”¹ç”± `_fallback_from_tej_price` åŸ·è¡Œå‚™æ´æŸ¥åƒ¹ï¼š
      1. å…ˆä»¥ `twse.stock_day` æŸ¥è©¢åŒä¸€æª”è‚¡ç¥¨çš„ç•¶æ—¥æ”¶ç›¤åƒ¹ã€‚
      2. è‹¥ TWSE ä»å¤±æ•—ï¼Œå†æ”¹ç”¨ `financial.get_verified_price`ã€‚
    - è‹¥å·¥å…·åç¨±ç‚ºå…¶ä»–é¡å‹çš„ `tej.*`ï¼Œå‰‡è‡ªå‹• fallback è‡³ `searxng.search`ï¼Œä½¿ç”¨é–‹æ”¾ç¶²è·¯æŸ¥æ‰¾åŸºæœ¬è³‡è¨Šã€‚
  - æˆåŠŸå–å¾—è³‡æ–™ä¸”é€šé EvidenceLifecycle é©—è­‰å¾Œï¼Œçµæœä»¥ã€Œå·²é©—è­‰è­‰æ“šã€å½¢å¼å¯«å…¥è¨˜æ†¶ï¼Œä¸¦ä½œç‚ºå¾ŒçºŒ 7 æ­¥åˆ†æçš„èƒŒæ™¯è³‡è¨Šã€‚

- 7 æ­¥è³½å‰åˆ†æ (`pre_debate_analysis`)ï¼š
  - ä¸»é«”åˆ†ææ­¥é©Ÿæœ¬èº«ä¸å†å…è¨±å·¥å…·èª¿ç”¨ï¼ˆç³»çµ±æç¤ºä¸­å·²æ˜ç¢ºè¦æ±‚ã€Œä¸è¦ä½¿ç”¨å·¥å…·ã€ï¼‰ã€‚
  - è‹¥ LLM ä¸ç¬¦åˆè¦æ±‚ï¼Œä»è¼¸å‡ºå·¥å…·å‘¼å« JSONï¼ˆåŒ…å« `tool`ã€`params`ï¼‰ï¼Œç³»çµ±æœƒï¼š
    - å„ªå…ˆåŸ·è¡Œè©²å·¥å…·ï¼Œè‹¥ç‚º `tej.*` ä¸”å¤±æ•—ï¼Œå¥—ç”¨èˆ‡ä¸Šè¿°ç›¸åŒçš„ fallback ç­–ç•¥ï¼š
      - åƒ¹æ ¼é¡ `tej.*` â†’ `_fallback_from_tej_price` â†’ `twse.stock_day` â†’ `financial.get_verified_price`
      - å…¶ä»– `tej.*` â†’ `searxng.search`
    - å°‡å·¥å…·çµæœä»¥æ–‡å­—é™„åŠ åˆ° Prompt ä¸­ï¼Œä¸¦è¦æ±‚ LLM å†æ¬¡è¼¸å‡ºç´” JSON åˆ†æçµæœï¼ˆä¸å†è®“å…¶è‡ªä¸»ç™¼å·¥å…·ï¼‰ã€‚

æ•´é«”ä¾†çœ‹ï¼Œç¾æœ‰å¯¦ä½œç¢ºä¿ï¼š

- TEJ å·¥å…·å¤±æ•—ï¼ˆ404ã€ç©ºè³‡æ–™ã€æš«æ™‚æ€§éŒ¯èª¤ï¼‰ä¸æœƒä¸­æ–·ä¸»å¸­æµç¨‹ã€‚
- åƒ¹æ ¼è³‡è¨Šæœƒè‡ªå‹•æ”¹ç”¨ TWSE èˆ‡å…§éƒ¨ verified price è³‡æ–™ä¾†è£œé½Šã€‚
- ä»»æ„éåƒ¹æ ¼å‹ TEJ å·¥å…·å¤±æ•—æ™‚ï¼Œæœƒæ”¹ç”¨ `searxng.search` ä½œç‚ºè³‡æ–™ä¾†æºã€‚

### 3. è¨˜æ†¶ç³»çµ±èˆ‡ TEJ å·¥å…·çš„æ¢ä»¶åŒ–è™•ç†

HippocampalMemory ä»¥åŠå…±äº«è¨˜æ†¶æœå°‹å° TEJ å·¥å…·æœ‰é¡å¤–æ²»ç†é‚è¼¯ï¼Œé¿å…åœ¨ç¦ç”¨ TEJ çš„ç’°å¢ƒä¸­æ®˜ç•™æˆ–æ³„æ¼èˆŠè³‡æ–™ï¼š

- åƒæ•¸æ­£è¦åŒ– `_normalize_params`ï¼š
  - æœƒå¾ `tool_registry` è®€å–å·¥å…· schemaï¼Œä¸¦å°‡ `ticker`ã€`symbol` ç­‰ alias æ­£è¦åŒ–ç‚º `coid`ã€‚
  - å°æ–¼ `tej.*` å·¥å…·ï¼Œè‹¥ `Config.ENABLE_TEJ_TOOLS == True`ï¼Œå‰‡æœƒå¼·åˆ¶ä½¿ç”¨ `coid` ä½œç‚ºä¸»éµæ¬„ä½ï¼Œä»¥æå‡ TEJ æŸ¥è©¢èˆ‡è¨˜æ†¶å‘½ä¸­ç‡ã€‚
  - è‹¥ `Config.ENABLE_TEJ_TOOLS == False`ï¼Œå‰‡ï¼š
    - ä»å¯å‘¼å«éè¨˜æ†¶ç›¸é—œé‚è¼¯ï¼Œä½† `_normalize_params` æœƒåœ¨è™•ç† `tej.*` æ™‚ç›´æ¥è·³éï¼Œä¸å°‡å…¶å¯«å…¥å·¥ä½œè¨˜æ†¶ç´¢å¼•ã€‚

- æœå°‹å…±äº«è¨˜æ†¶ `search_shared_memory`ï¼š
  - æª¢ç´¢è‡ª Qdrant ç­‰å‘é‡åº«çš„æ­·å²è¨˜æ†¶æ™‚ï¼Œæœƒæ ¹æ“š `tool` æ¬„ä½é€²è¡Œéæ¿¾ï¼š
    - è‹¥ `Config.ENABLE_TEJ_TOOLS == False` ä¸”è¨˜éŒ„ä¸­çš„ `tool` ä»¥ `tej.` é–‹é ­ï¼Œè©²æ¢è¨˜æ†¶æœƒè¢«å¿½ç•¥ï¼Œä¸å‡ºç¾åœ¨æœ€çµ‚è¼¸å‡ºã€‚

ä¸Šè¿°å…©å±¤æ²»ç†ç¢ºä¿ï¼š

- ç•¶ TEJ å·¥å…·æš«æ™‚åœç”¨æˆ–åœ¨ç„¡æ¬Šç’°å¢ƒä¸‹é‹è¡Œæ™‚ï¼Œæ—¢ä¸æœƒç¹¼çºŒå¯«å…¥æ–°çš„ TEJ è¨˜æ†¶ï¼Œä¹Ÿä¸æœƒå¾èˆŠæœ‰è¨˜æ†¶ä¸­è®€å‡º TEJ ç›¸é—œå…§å®¹ã€‚
- ç•¶ TEJ å·¥å…·å•Ÿç”¨æ™‚ï¼Œè¨˜æ†¶ç³»çµ±èˆ‡å·¥å…·é›†æ¬Šé™é…ç½®ä¿æŒä¸€è‡´ï¼Œä¿éšœåŒä¸€å±¤ç´šçš„æ²»ç†èªç¾©ã€‚

### 4. é–‹ç™¼è€…æ³¨æ„äº‹é …ï¼šTEJ è¨˜æ†¶æ²»ç† Checklist

åœ¨ä¿®æ”¹èˆ‡ TEJ ç›¸é—œé‚è¼¯æ™‚ï¼Œå¯ç”¨ä»¥ä¸‹æ¸…å–®å¿«é€Ÿæª¢æŸ¥æ˜¯å¦ç¬¦åˆç¾æœ‰æ²»ç†ç­–ç•¥ï¼š

- `Config.ENABLE_TEJ_TOOLS`ï¼š
  - æ–°å¢æˆ–ä¿®æ”¹ä»»ä½• `tej.*` å‘¼å«æ™‚ï¼Œå‹™å¿…ç¢ºèªåœ¨ã€Œå…¥å£è™•ã€æœ‰å°Šé‡æ­¤æ——æ¨™ï¼ˆç¦ç”¨æ™‚ä¸å¯ç›´æ¥æ‰“ TEJ APIï¼‰ã€‚
- è¨˜æ†¶å¯«å…¥ï¼ˆHippocampalMemory.store / `_normalize_params`ï¼‰ï¼š
  - ç•¶ `ENABLE_TEJ_TOOLS == False` æ™‚ï¼Œä¸å¾—å¯«å…¥ä»»ä½• `tej.*` è¨˜æ†¶ï¼ˆç¢ºèªæœ‰é¡ä¼¼ `tool_name.startswith("tej.")` çš„ guardï¼‰ã€‚
  - ç•¶ `ENABLE_TEJ_TOOLS == True` æ™‚ï¼Œèˆ‡ TEJ ç›¸é—œçš„ä¸»éµæ¬„ä½æ‡‰æ­£è¦åŒ–ç‚º `coid`ï¼Œé¿å…åŒä¸€å…¬å¸å¤šç¨®ä»£ç¢¼æ··ç”¨ã€‚
- è¨˜æ†¶è®€å–ï¼ˆ`search_shared_memory` / å…¶ä»–å…±äº«è¨˜æ†¶æŸ¥è©¢ï¼‰ï¼š
  - ç•¶ TEJ é—œé–‰æ™‚ï¼Œæ‡‰éæ¿¾æ‰æ‰€æœ‰ `tool` ä»¥ `tej.` é–‹é ­çš„è¨˜æ†¶é …ï¼Œé¿å…èˆŠè³‡æ–™åœ¨ç„¡æ¬Šç’°å¢ƒä¸­è¢«è®€å‡ºã€‚
- Fallback èˆ‡ EvidenceLifecycleï¼š
  - è‹¥ TEJ æŸ¥è©¢å¤±æ•—ï¼ˆ404ã€ç©ºè³‡æ–™ã€Recoverable errorï¼‰ï¼Œå„ªå…ˆèµ°æ—¢æœ‰ fallback éˆï¼ˆé‡‘èå·¥å…· / æœå°‹å·¥å…·ï¼‰ï¼Œä¸è¦ç›´æ¥æŠŠéŒ¯èª¤çµæœå¯«å…¥è¨˜æ†¶ã€‚
  - ç¢ºèªæ‰€æœ‰å·¥å…·çµæœä»ç¶“ç”± EvidenceLifecycle é©—è­‰å¾Œæ‰é€²å…¥å¿«å–èˆ‡ LTMã€‚
- æ¸¬è©¦èˆ‡æ–‡ä»¶ï¼š
  - æ–°å¢æˆ–èª¿æ•´ TEJ é‚è¼¯æ™‚ï¼Œå»ºè­°åŒæ­¥è£œ smoke testï¼Œè‡³å°‘è¦†è“‹ï¼š
    - TEJ é–‹å•Ÿï¼é—œé–‰å…©ç¨®æƒ…å¢ƒã€‚
    - è¨˜æ†¶å¯«å…¥æ˜¯å¦è¢«æ­£ç¢ºå…è¨±æˆ–æ‹’çµ•ã€‚
    - æŸ¥è©¢æ™‚ TEJ è¨˜æ†¶æ˜¯å¦è¢«æ­£ç¢ºéæ¿¾ã€‚
  - è‹¥æ›´å‹•è¡Œç‚ºèˆ‡æœ¬ç¯€æè¿°ä¸åŒï¼Œè¨˜å¾—åŒæ­¥æ›´æ–°æœ¬æ–‡ä»¶çš„ TEJ å°ç¯€ã€‚

---

## ä¸‹ä¸€æ­¥

1. **ç«‹å³å¯¦ç¾**ï¼šToolSet API ç«¯é»ï¼ˆ30 åˆ†é˜ï¼‰
2. **çŸ­æœŸ**ï¼šæ›´æ–° debate_cycle.pyï¼ˆ30 åˆ†é˜ï¼‰
3. **ä¸­æœŸ**ï¼šGradio å‰ç«¯ï¼ˆ2-3 å°æ™‚ï¼‰
