# EDA 工具數據範圍分析與擴展規劃

## 當前狀態（v1.0）

### 目前使用的數據

**數據來源**: Yahoo Finance  
**數據類型**: 股價 OHLCV（開高低收量）  
**數據欄位**:
- `date` - 日期
- `open` - 開盤價
- `high` - 最高價
- `low` - 最低價
- `close` - 收盤價
- `volume` - 成交量

**分析範圍**:
- ✅ 價格趨勢分析
- ✅ 波動率計算
- ✅ 成交量分析
- ✅ 價格分布（直方圖）
- ✅ 相關性分析（OHLCV 之間）

---

## 未使用的數據類型

### 1. 財務報表數據

**來源**: TEJ API, ChinaTimes API  
**包含**:
- 📊 損益表 (Income Statement)
  - 營收、毛利、淨利
  - EPS、ROE、ROA
- 📊 資產負債表 (Balance Sheet)
  - 總資產、負債、股東權益
  - 流動比率、負債比率
- 📊 現金流量表 (Cash Flow Statement)
  - 營業現金流、投資現金流、融資現金流
- 📊 財務比率
  - 本益比 (P/E)、股價淨值比 (P/B)
  - 股息殖利率、配息率

### 2. 進階 K 線數據

**來源**: TEJ API, TWSE API  
**包含**:
- 📈 技術指標
  - MA (移動平均線)
  - MACD、RSI、KD
  - 布林通道
- 📈 籌碼數據
  - 三大法人買賣超
  - 融資融券
  - 主力進出
- 📈 市場數據
  - 成交筆數
  - 外資持股比例
  - 內部人持股變化

### 3. 產業與總經數據

**來源**: TEJ API, ChinaTimes API  
**包含**:
- 🏭 產業指標
  - 產業平均本益比
  - 同業比較
- 🌍 總體經濟
  - GDP、CPI
  - 利率、匯率

---

## 有使用 vs 沒有使用的差異

### 場景對比

#### 場景 A: 僅使用股價數據（當前）

**辯論主題**: 「台積電 (2330.TW) 是否值得投資？」

**EDA 分析結果**:
```markdown
### EDA 自動分析報告

**分析標的**: 2330.TW  
**數據期間**: 120 個交易日  

**價格分析**:
- 平均收盤價：$950.25
- 價格標準差：$45.30
- 期間漲跌幅：+12.5%

**成交量分析**:
- 平均日成交量：25,000,000 股
- 成交量與價格相關性：0.35

**風險指標**:
- 波動率：4.5%
```

**主席總結能力**:
- ✅ 可以評估價格趨勢
- ✅ 可以分析波動風險
- ❌ **無法評估公司基本面**
- ❌ **無法判斷估值是否合理**
- ❌ **無法比較同業表現**

---

#### 場景 B: 整合財務報表（擴展後）

**EDA 分析結果**:
```markdown
### EDA 自動分析報告

**分析標的**: 2330.TW  
**數據期間**: 120 個交易日 + 最近 4 季財報  

**價格分析**:
- 平均收盤價：$950.25
- 價格標準差：$45.30
- 期間漲跌幅：+12.5%

**財務健康度**:
- 營收成長率（YoY）：+15.2%
- 毛利率：52.3%
- EPS（最近季）：$8.5
- ROE：25.6%

**估值分析**:
- 本益比：22.5x（產業平均：18.3x）
- 股價淨值比：5.2x
- 股息殖利率：2.8%

**財務比率趨勢**:
- 負債比率：35.2%（健康）
- 流動比率：1.8（良好）
- 現金流量：穩定成長
```

**主席總結能力**:
- ✅ 可以評估價格趨勢
- ✅ 可以分析波動風險
- ✅ **可以評估公司基本面**
- ✅ **可以判斷估值是否合理**
- ✅ **可以比較同業表現**
- ✅ **可以提供更全面的投資建議**

---

#### 場景 C: 整合 K 線技術指標（進階擴展）

**EDA 分析結果**:
```markdown
### EDA 自動分析報告

**分析標的**: 2330.TW  
**數據期間**: 120 個交易日 + 技術指標  

**價格分析**:
- 平均收盤價：$950.25
- 當前價格相對 MA20：+3.2%
- 當前價格相對 MA60：+8.5%

**技術指標**:
- RSI (14)：65（偏多但未超買）
- MACD：黃金交叉（2024-12-10）
- 布林通道：價格位於上軌附近

**籌碼分析**:
- 外資持股比例：76.5%
- 近 5 日外資買超：+12,000 張
- 融資餘額：下降趨勢（健康）

**技術面評估**:
- 趨勢：多頭格局
- 支撐位：$920
- 壓力位：$980
```

**主席總結能力**:
- ✅ 所有場景 B 的能力
- ✅ **可以評估技術面多空**
- ✅ **可以識別買賣時機**
- ✅ **可以分析籌碼面**
- ✅ **提供更精準的進出場建議**

---

## 數據整合的價值矩陣

| 數據類型 | 分析維度 | 主席價值 | 實作難度 | 優先級 |
|---------|---------|---------|---------|--------|
| **股價 OHLCV** | 價格趨勢、波動 | ⭐⭐⭐ | 低（已完成） | P0 ✅ |
| **財務報表** | 基本面、估值 | ⭐⭐⭐⭐⭐ | 中 | **P1** 🔥 |
| **技術指標** | 技術面、時機 | ⭐⭐⭐⭐ | 中 | P2 |
| **籌碼數據** | 資金流向 | ⭐⭐⭐ | 高 | P3 |
| **產業數據** | 同業比較 | ⭐⭐⭐⭐ | 中 | P2 |

---

## 實作建議

### 階段 1: 整合財務報表（建議優先）

**為什麼優先**:
1. 對投資決策影響最大
2. TEJ/ChinaTimes API 已可用
3. 與現有 EDA 流程相容

**實作方式**:

#### 選項 A: 擴展 EDA Tool（推薦）

```python
# 在 EDAToolAdapter 中新增財務數據拉取
async def _prepare_financial_data(self, symbol: str, debate_id: str) -> dict:
    """拉取財務報表數據"""
    from worker.tool_invoker import call_tool
    
    # 拉取財務比率
    financial_ratios = await call_tool("chinatimes.financial_ratios", {"code": symbol})
    
    # 拉取基本面
    fundamentals = await call_tool("chinatimes.stock_fundamental", {"code": symbol})
    
    # 合併到 CSV 或單獨分析
    return {
        "ratios": financial_ratios,
        "fundamentals": fundamentals
    }
```

**優點**:
- ✅ 一次調用獲得完整分析
- ✅ 財務數據與股價數據關聯分析
- ✅ 統一的 Evidence 管理

**缺點**:
- ⚠️ 工具執行時間變長（可能 40-60 秒）
- ⚠️ 需要處理不同數據格式

#### 選項 B: 獨立財務分析工具

```python
# 創建新工具 chairman.financial_analysis
class FinancialAnalysisToolAdapter(ToolAdapter):
    def invoke(self, symbol, debate_id):
        # 僅分析財務報表
        # 返回財務健康度評分
        pass
```

**優點**:
- ✅ 職責分離，更靈活
- ✅ 可獨立調用或組合使用
- ✅ 執行時間可控

**缺點**:
- ⚠️ 主席需要調用兩個工具
- ⚠️ 數據關聯分析需要額外邏輯

---

### 階段 2: 整合技術指標

**實作方式**: 使用 `ta-lib` 或 `pandas-ta` 計算技術指標

```python
import pandas_ta as ta

# 在 EDA Service 中新增技術指標計算
df['MA20'] = df['close'].rolling(20).mean()
df['MA60'] = df['close'].rolling(60).mean()
df['RSI'] = ta.rsi(df['close'], length=14)
df['MACD'] = ta.macd(df['close'])
```

**優點**:
- ✅ 基於現有股價數據計算
- ✅ 不需要額外 API 調用
- ✅ ydata-profiling 可自動分析

---

## 推薦實作路徑

### 🎯 建議採用：選項 A（擴展 EDA Tool）

**理由**:
1. **一致性**: 主席只需調用一個工具
2. **完整性**: 價格 + 財務 + 技術指標全面分析
3. **效率**: 一次性生成完整報表

**實作步驟**:

1. **擴展數據準備** (2-3 小時)
   ```python
   # 在 _prepare_stock_data 後新增
   financial_data = await self._prepare_financial_data(symbol, debate_id)
   technical_indicators = self._calculate_technical_indicators(df)
   ```

2. **擴展 CSV 結構** (1 小時)
   ```python
   # 合併數據到單一 DataFrame
   df_combined = pd.merge(df_price, df_financial, on='date', how='left')
   ```

3. **更新 EDA Service** (1 小時)
   - ydata-profiling 會自動分析新欄位
   - 生成更豐富的報表

4. **更新 Gate Checker** (1 小時)
   - 新增財務數據品質檢查
   - 檢查關鍵比率是否存在

**總計**: 約 5-6 小時

---

## 對比總結

### 當前版本（僅股價）

**適用場景**:
- ✅ 快速技術面分析
- ✅ 價格趨勢判斷
- ✅ 波動風險評估

**限制**:
- ❌ 無法評估公司價值
- ❌ 無法判斷估值高低
- ❌ 缺乏基本面支持

### 擴展版本（股價 + 財務）

**適用場景**:
- ✅ 所有當前版本場景
- ✅ **價值投資分析**
- ✅ **基本面評估**
- ✅ **估值合理性判斷**
- ✅ **同業比較**

**主席總結品質提升**:
- 從「技術面描述」→「全面投資建議」
- 從「價格分析」→「價值分析」
- 從「單一維度」→「多維度交叉驗證」

---

## 建議

### 短期（本次迭代）
1. ✅ 保持當前版本運行
2. 📝 記錄擴展需求到 backlog
3. 🧪 先完成端到端測試

### 中期（下次迭代）
1. 🔧 實作財務報表整合（選項 A）
2. 📊 新增技術指標計算
3. 🧪 驗證擴展版本效果

### 長期（未來規劃）
1. 🤖 整合 LLM 自動解讀（PandasAI）
2. 📈 新增籌碼面分析
3. 🌍 整合總經數據

---

## 結論

**當前 EDA 工具**是一個良好的起點，提供了基礎的價格分析能力。

**整合財務報表後**，主席將能夠：
- 從「技術分析師」升級為「全面投資顧問」
- 提供更有說服力的總結
- 基於多維度數據做出更準確的判斷

**建議**: 先完成當前版本的驗證，確認架構穩定後，再進行財務數據整合。
