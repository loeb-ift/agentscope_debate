<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <title>研究進度 - MARS V2</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-gray-50 p-6">
    <div class="max-w-6xl mx-auto">
        <div class="flex justify-between items-center mb-6">
            <h1 class="text-2xl font-bold text-gray-800">研究任務監控</h1>
            <a href="/" class="text-blue-500 hover:underline">返回首頁</a>
        </div>

        <div class="bg-white p-6 rounded shadow mb-6">
            <h2 class="text-xl font-bold mb-2">主題: <span id="topic" class="text-purple-600">Loading...</span></h2>
            <div class="flex items-center space-x-2">
                <span class="font-bold">狀態:</span>
                <span id="status" class="px-2 py-1 bg-gray-200 rounded text-sm">未知</span>
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <!-- Artifacts Column -->
            <div class="bg-white p-6 rounded shadow">
                <h3 class="text-lg font-bold mb-4 border-b pb-2">Artifacts (證據/產出)</h3>
                <div id="artifacts-list" class="space-y-4 max-h-[600px] overflow-y-auto">
                    <p class="text-gray-500">等待產出中...</p>
                </div>
            </div>

            <!-- Logs/Details Column (Placeholder for graph) -->
            <div class="bg-white p-6 rounded shadow">
                <h3 class="text-lg font-bold mb-4 border-b pb-2">執行日誌</h3>
                <div class="text-sm text-gray-600 font-mono" id="debug-info">
                    Polling API...
                </div>
            </div>
        </div>
    </div>

    <script>
        // Dynamically determine API URL based on current page location
        const API_HOST = window.location.hostname;
        const API_BASE = `http://${API_HOST}:8000/api/v2`;

        const urlParams = new URLSearchParams(window.location.search);
        const taskId = urlParams.get('id');

        if (!taskId) {
            alert("無效的任務 ID");
            window.location.href = "/";
        }

        async function pollStatus() {
            try {
                const res = await fetch(`${API_BASE}/research/${taskId}`);
                const data = await res.json();

                document.getElementById('topic').innerText = data.topic;
                document.getElementById('status').innerText = data.status;

                if (data.status === 'completed') {
                    document.getElementById('status').className = "px-2 py-1 bg-green-200 text-green-800 rounded text-sm";
                } else if (data.status === 'failed') {
                    document.getElementById('status').className = "px-2 py-1 bg-red-200 text-red-800 rounded text-sm";
                }

                // Render Artifacts
                const list = document.getElementById('artifacts-list');
                if (data.artifacts && data.artifacts.length > 0) {
                    list.innerHTML = data.artifacts.map(art => {
                        let content = art.content;
                        try {
                            // Try to format JSON content
                            const json = JSON.parse(content);
                            content = `<pre class="text-xs bg-gray-100 p-2 overflow-x-auto">${JSON.stringify(json, null, 2)}</pre>`;
                        } catch (e) {
                            // Plain text
                        }

                        return `
                        <div class="border rounded p-3 hover:bg-gray-50">
                            <div class="flex justify-between mb-1">
                                <span class="font-bold text-sm text-blue-600">${art.id}</span>
                                <span class="text-xs text-gray-400">${art.type}</span>
                            </div>
                            <div class="text-sm text-gray-700">${content}</div>
                            <div class="mt-2 text-xs text-gray-400">
                                Source: ${art.source_agent} | Tool: ${art.metadata?.tool || 'N/A'}
                            </div>
                        </div>
                        `;
                    }).join('');
                }

                if (data.status !== 'completed' && data.status !== 'failed') {
                    setTimeout(pollStatus, 2000);
                }
            } catch (e) {
                console.error(e);
            }
        }

        pollStatus();
    </script>
</body>

</html>