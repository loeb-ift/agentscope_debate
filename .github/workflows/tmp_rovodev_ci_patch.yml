name: CI-Extended
on: [pull_request]

jobs:
  backend-tests-matrix:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        cache_backend: [memory, redis]
    services:
      redis:
        image: redis:7
        ports: ["6379:6379"]
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - name: Install Python deps
        run: |
          pip install -r requirements.txt || true
          if [ -f api/requirements.txt ]; then pip install -r api/requirements.txt; fi
          pip install pytest requests
      - name: Start services with docker compose
        run: |
          docker compose up -d --build
          sleep 5
      - name: Wait for health
        run: |
          for i in {1..60}; do curl -sf http://localhost:8000/health && break || sleep 2; done
      - name: Initialize data (prompts/global/seed)
        env:
          EFFECTIVE_TOOLS_CACHE: ${{ matrix.cache_backend }}
          REDIS_URL: redis://localhost:6379/0
        run: |
          python - <<'PY'
from scripts.refresh_prompts import main as refresh_main
refresh_main()
print('OK refresh_prompts')
PY
          curl -sf -X POST http://localhost:8000/api/v1/toolsets/initialize-global
          python - <<'PY'
from api.init_data import initialize_all
from api.database import SessionLocal
db=SessionLocal(); initialize_all(db); db.close(); print('OK seed agents')
PY
      - name: Run API tests (smoke + effective tools)
        env:
          EFFECTIVE_TOOLS_CACHE: ${{ matrix.cache_backend }}
          REDIS_URL: redis://localhost:6379/0
        run: |
          pytest -q scripts/tests/test_smoke_api.py -q
          pytest -q scripts/tests/test_effective_tools_api.py -q
          pytest -q scripts/tests/test_effective_tools_precedence_and_prompt.py -q
          pytest -q scripts/tests/test_effective_tools_cache_invalidation.py -q
